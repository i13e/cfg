#!/usr/bin/zsh
source "/usr/share/fzf/completion.zsh"
source "/usr/share/fzf/key-bindings.zsh"

# (EXPERIMENTAL) Advanced customization of fzf options via _fzf_comprun function
# - The first argument to the function is the name of the command.
# - You should make sure to pass the rest of the arguments to fzf.
_fzf_comprun() {
    local command=$1
    shift

    case "$command" in
        cd)           fzf "$@" --preview 'exa -T {} | head -200' ;;
        #cd)           find . -type d | fzf --height 50% --border sharp --margin 5% --preview 'tree -C {} | head -n 10';;
        export|unset) fzf "$@" --preview "eval 'echo \$'{}" ;;
        ssh)          fzf "$@" --preview 'drill {}' ;;
        *)            fzf "$@" ;;
    esac
}
# # Search with fzf and open selected file with Vim
# # bindkey -s '^v' 'vim $(fzf);^M'

#
# # +-----+
# # | Git |
# # +-----+
#
# # git log browser with FZF
# fglog() {
#   git log --graph --color=always \
#       --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
#   fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
#       --bind "ctrl-m:execute:
#                 (grep -o '[a-f0-9]\{7\}' | head -1 |
#                 xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
#                 {}
# FZF-EOF"
# }
#
# # +--------+
# # | Pacman |
# # +--------+
#
# # TODO can improve that with a bind to switch to what was installed
# fpac() {
#     pacman -Slq | fzf --multi --reverse --preview 'pacman -Si {1}' | xargs -ro sudo pacman -S
# }
#
# fyay() {
#     yay -Slq | fzf --multi --reverse --preview 'yay -Si {1}' | xargs -ro yay -S
# }
#
# # +------+
# # | tmux |
# # +------+
#
# fmux() {
#     prj=$(find $XDG_CONFIG_HOME/tmuxp/ -execdir bash -c 'basename "${0%.*}"' {} ';' | sort | uniq | nl | fzf | cut -f 2)
#     echo $prj
#     [ -n "$prj" ] && tmuxp load $prj
# }
#
# # ftmuxp - propose every possible tmuxp session
# ftmuxp() {
#     if [[ -n $TMUX ]]; then
#         return
#     fi
#
#     # get the IDs
#     ID="$(ls $XDG_CONFIG_HOME/tmuxp | sed -e 's/\.yml$//')"
#     if [[ -z "$ID" ]]; then
#         tmux new-session
#     fi
#
#     create_new_session="Create New Session"
#
#     ID="${create_new_session}\n$ID"
#     ID="$(echo $ID | fzf | cut -d: -f1)"
#
#     if [[ "$ID" = "${create_new_session}" ]]; then
#         tmux new-session
#     elif [[ -n "$ID" ]]; then
#         # Change name of urxvt tab to session name
#         printf '\033]777;tabbedx;set_tab_name;%s\007' "$ID"
#         tmuxp load "$ID"
#     fi
# }
#
# # ftmux - help you choose tmux sessions
# ftmux() {
#     if [[ ! -n $TMUX ]]; then
#         # get the IDs
#         ID="`tmux list-sessions`"
#         if [[ -z "$ID" ]]; then
#             tmux new-session
#         fi
#         create_new_session="Create New Session"
#         ID="$ID\n${create_new_session}:"
#         ID="`echo $ID | fzf | cut -d: -f1`"
#         if [[ "$ID" = "${create_new_session}" ]]; then
#             tmux new-session
#         elif [[ -n "$ID" ]]; then
#             printf '\033]777;tabbedx;set_tab_name;%s\007' "$ID"
#             tmux attach-session -t "$ID"
#         else
#             :  # Start terminal normally
#         fi
#     fi
# }
#
# # +-------+
# # | Other |
# # +-------+
#
# # List install files for dotfiles
# fdot() {
#     file=$(find "$DOTFILES/install" -exec basename {} ';' | sort | uniq | nl | fzf | cut -f 2)
#     [ -n "$file" ] && "$EDITOR" "$DOTFILES/install/$file"
# }
#
# # List projects
# fwork() {
#     result=$(find ~/workspace/* -type d -prune -exec basename {} ';' | sort | uniq | nl | fzf | cut -f 2)
#     [ -n "$result" ] && cd ~/workspace/$result
# }
#
# fpdf() {
#     result=$(find -type f -name '*.pdf' | fzf --bind "ctrl-r:reload(find -type f -name '*.pdf')" --preview "pdftotext {} - | less")
#     [ -n "$result" ] && zathura "$result" &
# }
#
# fepub() {
#     result=$(find -type f -name '*.epub' | fzf --bind "ctrl-r:reload(find -type f -name '*.epub')")
#     [ -n "$result" ] && zathura "$result" &
# }
#
# # List mindmaps
# fmind() {
#     local folders=("$CLOUD/knowledge_base" "$WORKSPACE/alexandria")
#
#     files=""
#     for root in ${folders[@]}; do
#         files="$files $(find $root -name '*.mm')"
#     done
#     result=$(echo "$files" | fzf -m --height 60% --border sharp | tr -s "\n" " ")
#     [ -n "$result" ] && freemind $(echo $result) &> /dev/null &
# }
#
# # List tracking spreadsheets (productivity, money ...)
# ftrack() {
#     file=$(ls $CLOUD/tracking/**/*.{ods,csv} | fzf) || return
#     [ -n "$file" ] && libreoffice "$file" &> /dev/null &
# }
#
# fpop() {
#     # Only work with alias d defined as:
#
#     # alias d='dirs -v'
#     # for index ({1..9}) alias "$index"="cd +${index}"; unset index
#
#     d | fzf --height="20%" | cut -f 1 | source /dev/stdin
# }
